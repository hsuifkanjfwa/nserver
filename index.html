<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CEX 永续合约资金费率监控</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- 在线 JS：dayjs 用来格式化时间 -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
            Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #020617;
            color: #e5e7eb;
        }

        header {
            padding: 16px 24px;
            border-bottom: 1px solid #111827;
            background: linear-gradient(135deg, #020617, #020617 40%, #111827);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 20px;
        }

        header p {
            margin: 4px 0 0;
            font-size: 12px;
            color: #9ca3af;
        }

        .container {
            max-width: 1200px;
            margin: 16px auto 32px;
            padding: 0 16px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .left-controls, .right-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        button {
            border: 1px solid #4b5563;
            background-color: #111827;
            color: #e5e7eb;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        button:hover {
            background-color: #1f2937;
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        select {
            background-color: #020617;
            color: #e5e7eb;
            border-radius: 999px;
            border: 1px solid #4b5563;
            padding: 6px 10px;
            font-size: 12px;
        }

        .time-text {
            font-size: 11px;
            color: #9ca3af;
        }

        .table-wrapper {
            background-color: #020617;
            border-radius: 12px;
            border: 1px solid #1f2937;
            padding: 10px 12px 14px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 640px;
        }

        thead {
            background-color: #020617;
        }

        th, td {
            padding: 8px 6px;
            text-align: right;
            border-bottom: 1px solid #111827;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        th {
            font-weight: 500;
            color: #9ca3af;
            font-size: 11px;
        }

        tr:hover td {
            background-color: rgba(15, 23, 42, 0.9);
        }

        .cex-name {
            font-weight: 600;
            font-size: 12px;
        }

        .pair {
            font-weight: 500;
            font-size: 12px;
        }

        .positive { color: #4ade80; }
        .negative { color: #fca5a5; }
        .neutral  { color: #e5e7eb; }

        .cex-tag {
            display: inline-block;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background-color: #111827;
            color: #9ca3af;
            margin-left: 6px;
        }

        .error {
            color: #fca5a5;
            font-size: 11px;
            margin-top: 4px;
        }

        .footer {
            margin-top: 24px;
            font-size: 11px;
            color: #6b7280;
            text-align: center;
        }

        .footer a {
            color: #9ca3af;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<header>
    <h1>CEX 永续合约资金费率监控</h1>
    <p>实时拉取部分主流交易所 Funding Rate（仅作演示，请自行核对数据）</p>
</header>

<div class="container">

    <section class="controls">
        <div class="left-controls">
            <label for="symbolSelect" style="font-size:12px;">交易对：</label>
            <select id="symbolSelect">
                <option value="BTCUSDT">BTCUSDT</option>
                <option value="ETHUSDT">ETHUSDT</option>
                <option value="BNBUSDT">BNBUSDT</option>
            </select>

            <label for="intervalSelect" style="font-size:12px;">资金费率周期：</label>
            <select id="intervalSelect">
                <option value="8h">8 小时</option>
                <option value="1h">1 小时</option>
            </select>
        </div>

        <div class="right-controls">
            <button id="refreshBtn">立即刷新</button>
            <span class="time-text" id="updateTimeText">上次更新：—</span>
        </div>
    </section>

    <section class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>交易所</th>
                <th>品种</th>
                <th>当前资金费率</th>
                <th>下一次结算时间</th>
                <th>原始数据</th>
            </tr>
            </thead>
            <tbody id="fundingTableBody">
            <!-- JS 动态填充 -->
            </tbody>
        </table>
        <div id="errorBox" class="error"></div>
    </section>

    <div class="footer">
        数据来源：公开 REST API（Binance / OKX / Bybit 等），仅供参考，不构成投资建议。<br>
        如需自定义更多交易所与交易对，请直接编辑本页面 JS 配置。
    </div>
</div>

<script>
    // ===== 配置要展示的交易所 =====
    // 可自行增删
    const EXCHANGES = [
        { id: 'binance', name: 'Binance', tag: 'USDT 合约' },
        { id: 'okx',     name: 'OKX',     tag: 'USDT 永续' },
        { id: 'bybit',   name: 'Bybit',   tag: 'USDT 永续' }
    ];

    const symbolSelect   = document.getElementById('symbolSelect');
    const intervalSelect = document.getElementById('intervalSelect');
    const refreshBtn     = document.getElementById('refreshBtn');
    const tableBody      = document.getElementById('fundingTableBody');
    const updateTimeText = document.getElementById('updateTimeText');
    const errorBox       = document.getElementById('errorBox');

    function setLoadingState(loading) {
        refreshBtn.disabled = loading;
        refreshBtn.textContent = loading ? '刷新中…' : '立即刷新';
    }

    function formatRate(rate) {
        if (rate === null || rate === undefined || isNaN(rate)) return '—';
        return (rate * 100).toFixed(4) + '%';
    }

    function formatTimestamp(ts) {
        if (!ts) return '—';
        try {
            // ts 可能是 ms 或 s 级时间戳
            if (ts < 1e12) ts *= 1000;
            return dayjs(ts).format('YYYY-MM-DD HH:mm:ss');
        } catch (e) {
            return '—';
        }
    }

    function getDirectionClass(rate) {
        if (rate > 0) return 'positive';
        if (rate < 0) return 'negative';
        return 'neutral';
    }

    // ===== 各交易所 Funding Rate 获取函数（均返回统一结构） =====

    // Binance: https://fapi.binance.com/fapi/v1/premiumIndex?symbol=BTCUSDT
    async function fetchBinanceFunding(symbol) {
        const url = 'https://fapi.binance.com/fapi/v1/premiumIndex?symbol=' + encodeURIComponent(symbol);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Binance 请求失败');
        const data = await res.json();

        // data.lastFundingRate, data.nextFundingTime
        const rate = parseFloat(data.lastFundingRate);
        return {
            exchange: 'Binance',
            pair: data.symbol,
            rate: rate,
            nextFundingTime: data.nextFundingTime,
            raw: data
        };
    }

    // OKX: https://www.okx.com/api/v5/public/funding-rate?instId=BTC-USDT-SWAP
    function okxSymbol(symbol) {
        // 简单映射：BTCUSDT -> BTC-USDT-SWAP
        const base = symbol.replace('USDT', '');
        return base + '-USDT-SWAP';
    }

    async function fetchOkxFunding(symbol) {
        const instId = okxSymbol(symbol);
        const url = 'https://www.okx.com/api/v5/public/funding-rate?instId=' + encodeURIComponent(instId);
        const res = await fetch(url);
        if (!res.ok) throw new Error('OKX 请求失败');
        const json = await res.json();
        const data = (json.data && json.data[0]) || {};
        const rate = parseFloat(data.fundingRate);

        return {
            exchange: 'OKX',
            pair: data.instId || instId,
            rate: rate,
            nextFundingTime: parseInt(data.nextFundingTime || 0, 10),
            raw: data
        };
    }

    // Bybit: https://api.bybit.com/v5/market/funding/history?category=linear&symbol=BTCUSDT
    async function fetchBybitFunding(symbol) {
        const url = 'https://api.bybit.com/v5/market/funding/history?category=linear&limit=1&symbol='
            + encodeURIComponent(symbol);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Bybit 请求失败');
        const json = await res.json();
        const item = (json.result && json.result.list && json.result.list[0]) || {};
        const rate = parseFloat(item.fundingRate);

        return {
            exchange: 'Bybit',
            pair: item.symbol || symbol,
            rate: rate,
            nextFundingTime: parseInt(item.nextFundingTime || item.fundingRateTimestamp || 0, 10),
            raw: item
        };
    }

    async function fetchAllFunding() {
        setLoadingState(true);
        errorBox.textContent = '';
        tableBody.innerHTML = '';

        const symbol  = symbolSelect.value;
        const interval = intervalSelect.value; // 这里暂时只展示，不参与计算

        const promises = [
            fetchBinanceFunding(symbol).catch(err => ({ error: err })),
            fetchOkxFunding(symbol).catch(err => ({ error: err })),
            fetchBybitFunding(symbol).catch(err => ({ error: err }))
        ];

        const results = await Promise.all(promises);

        let hasError = false;

        results.forEach((res, idx) => {
            const ex = EXCHANGES[idx];
            const tr = document.createElement('tr');

            if (res.error) {
                hasError = true;
                tr.innerHTML = `
                    <td>
                        <span class="cex-name">${ex.name}</span>
                        <span class="cex-tag">${ex.tag}</span>
                    </td>
                    <td class="pair">${symbol}</td>
                    <td colspan="3" class="negative" style="text-align:left;">
                        请求失败：${res.error.message || res.error}
                    </td>
                `;
                tableBody.appendChild(tr);
                return;
            }

            const rateClass = getDirectionClass(res.rate);
            const rateText  = formatRate(res.rate);

            tr.innerHTML = `
                <td>
                    <span class="cex-name">${ex.name}</span>
                    <span class="cex-tag">${ex.tag}</span>
                </td>
                <td class="pair">${res.pair || symbol}</td>
                <td class="${rateClass}">${rateText}</td>
                <td>${formatTimestamp(res.nextFundingTime)}</td>
                <td style="font-size:11px; max-width:260px; text-align:left;">
                    ${JSON.stringify(res.raw)}
                </td>
            `;
            tableBody.appendChild(tr);
        });

        if (hasError) {
            errorBox.textContent = '部分交易所请求失败，可能是网络问题、CORS 限制或 API 变更。请打开 F12 控制台查看详细错误信息。';
        }

        updateTimeText.textContent = '上次更新：' + dayjs().format('YYYY-MM-DD HH:mm:ss');
        setLoadingState(false);
    }

    // 事件绑定
    refreshBtn.addEventListener('click', fetchAllFunding);
    symbolSelect.addEventListener('change', fetchAllFunding);
    intervalSelect.addEventListener('change', fetchAllFunding);

    // 页面加载后自动拉一次
    fetchAllFunding();
</script>

</body>
</html>
